<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Tracing Python Applications | Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.snappyflow.io//docs/Tracing/python"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Tracing Python Applications | Documentation"><meta data-react-helmet="true" name="description" content="Available Platforms"><meta data-react-helmet="true" property="og:description" content="Available Platforms"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.snappyflow.io//docs/Tracing/python"><link data-react-helmet="true" rel="alternate" href="https://docs.snappyflow.io//docs/Tracing/python" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.snappyflow.io//docs/Tracing/python" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.4614654b.css">
<link rel="preload" href="/assets/js/runtime~main.0c660305.js" as="script">
<link rel="preload" href="/assets/js/main.121dd3aa.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.snappyflow.io/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/logo-new.png" alt="SnappyFlow" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo-new.png" alt="SnappyFlow" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title"></b></a><a class="navbar__item navbar__link navbar__link--active" target="_self" href="/">Docs</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist" href="#">Quick Start Guide</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Quick_Start/getting_started">Getting Started</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/os/linux/sfagent_linux">sfAgent Installation on Linux</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/os/windows/sfagent_windows">sfAgent Installation on Windows</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/kubernetes/sfkubeagent_installation">Monitoring Application Pods with sfKubeAgent</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Tracing</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Tracing/overview">Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Tracing/java">Java</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Tracing/python">Python</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Tracing/ruby">Ruby</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Tracing/nodejs">NodeJS</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Tracing/csharp">C#</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Tracing/go">Go</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist" href="#">Integrations</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/overview">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">JAVA</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Nginx</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Kubernetes</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Postgres</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">MySQL</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Apache</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Operating Systems</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">StatsD</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/activemq">ActiveMQ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/kafka">Kafka</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/zookeeper">ZooKeeper</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrations/mongodb">MongoDB</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Log Management</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Dashboards</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Alerts &amp; Notifications</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Tracing Python Applications</h1></header><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="available-platforms"></a>Available Platforms<a class="hash-link" href="#available-platforms" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="instances"></a><a href="/docs/Tracing/python#instances">Instances</a><a class="hash-link" href="#instances" title="Direct link to heading">#</a></h5><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="docker"></a><a href="/docs/Tracing/python#docker">Docker</a><a class="hash-link" href="#docker" title="Direct link to heading">#</a></h5><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="kubernetes"></a><a href="/docs/Tracing/python#kubernetes">Kubernetes</a><a class="hash-link" href="#kubernetes" title="Direct link to heading">#</a></h5><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="ecs"></a><a href="/docs/Tracing/python#ecs">ECS</a><a class="hash-link" href="#ecs" title="Direct link to heading">#</a></h5><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="aws-lambda"></a><a href="/docs/Tracing/python#aws-lambda">AWS Lambda</a><a class="hash-link" href="#aws-lambda" title="Direct link to heading">#</a></h5><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="instances-1"></a>Instances<a class="hash-link" href="#instances-1" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="django"></a>Django<a class="hash-link" href="#django" title="Direct link to heading">#</a></h3><ol><li><p>Add </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf-elastic-apm==6.3.4</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf-apm-lib==0.1.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variable. </p></li><li><p>Add following entries in settings.py</p><ol><li><p>Add import statement </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in INSTALLED_APPS</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in MIDDLEWARE</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django.middleware.TracingMiddleware&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add this entry for instrumenting Django app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ELASTIC_APM</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;Service name&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DJANGO_TRANSACTION_NAME_FROM_ROUTE&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CENTRAL_CONFIG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Once your server is up and running you can check trace in Snappyflow Server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p> Once project and app name is created go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>For complete code refer sample app refer at: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django</a> </p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="flask"></a>Flask<a class="hash-link" href="#flask" title="Direct link to heading">#</a></h3><ol><li><p>Add </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flask</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm[flask]==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variable. </p></li><li><p>Add following entries in app.py </p><ol><li><p>Add imports statement</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ElasticAPM </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Get trace config</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Initialize elastic apm and instrument it to flask app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;ELASTIC_APM&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SERVICE_NAME&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">apm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ElasticAPM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once your server is up and running you can check trace in Snappyflow Server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li></ol></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="script"></a>Script<a class="hash-link" href="#script" title="Direct link to heading">#</a></h3><ol><li><p>Install following requirements</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following code at start of script file to setup elastic apm client</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> elasticapm </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will pick profileKey, projectName and appName from sfagent config.yaml.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;Snappyflow Project Name&gt;&#x27;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;Snappyflow App Name&gt;&#x27;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;Snappyflow Profile Key&gt;&#x27;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">trace_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Returns trace config </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;Service name&gt; &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token comment" style="color:#999988;font-style:italic"># Specify service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   server_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   verify_cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   global_labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Only call this once, as early as possible. </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once instrumentation is completed we can create custom transaction and span</p><p>Example</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    sess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Session</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> url </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;https://www.elastic.co&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;https://benchmarks.elastic.co&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        resp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sess</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">begin_transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transaction_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;script&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Record an exception </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> ZeroDivisionError</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ident </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capture_exception</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Exception caught; reference is %s&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> ident</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">end_transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;success&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Refer link to know more: </p><p><a href="https://www.elastic.co/guide/en/apm/agent/python/master/instrumenting-custom-code.html" target="_blank" rel="noopener noreferrer">https://www.elastic.co/guide/en/apm/agent/python/master/instrumenting-custom-code.html</a> </p></li><li><p>Now run you script and test your trace in snappyflow server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on left side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li></ol><ol start="5"><li><p>Refer complete script: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/blob/master/refapp-django/python_script_trace.py" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/blob/master/refapp-django/python_script_trace.py</a> </p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="celery"></a>Celery<a class="hash-link" href="#celery" title="Direct link to heading">#</a></h3><ol><li><p>Install following requirements (Following example is based on redis broker)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install redis </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following code at start of the file where celery app is initialized to setup elastic apm client</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">celery </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> register_exception_tracking</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> register_instrumentation </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROJECT_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow project name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_APP_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow app name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROFILE_KEY&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace Snappyflow Profile key</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   apm_client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;Service_Name&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify service name for tracing</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      server_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      global_labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      verify_server_cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_exception_tracking</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_instrumentation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once instrumentation is done and celery worker is running we can see trace for each celery task in Snappyflow server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on left side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>Refer complete code: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py</a> </p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="kubernetes-1"></a>Kubernetes<a class="hash-link" href="#kubernetes-1" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="django-1"></a>Django<a class="hash-link" href="#django-1" title="Direct link to heading">#</a></h3><ol><li><p>Add</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entries in settings.py </p><ol><li><p>Add import statement </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in INSTALLED_APPS</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in MIDDLEWARE</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django.middleware.TracingMiddleware&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add this entry for instrumenting Django app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ELASTIC_APM</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;Service name&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DJANGO_TRANSACTION_NAME_FROM_ROUTE&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CENTRAL_CONFIG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variables in Kubernetes deployment file. </p><p><a href="https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/</a> </p></li></ol><p>   If deploying with helm provide above variables in values.yaml and use them in deployment file of charts. </p><p>   <a href="https://phoenixnap.com/kb/helm-environment-variables" target="_blank" rel="noopener noreferrer">https://phoenixnap.com/kb/helm-environment-variables</a> </p><ol start="4"><li><p>Once your server is up and running you can check trace in Snappyflow Server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>For complete code refer sample app refer at: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django</a></p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="flask-1"></a>Flask<a class="hash-link" href="#flask-1" title="Direct link to heading">#</a></h3><ol><li><p>Add </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flask</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-elastic-apm[flask]==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entries in app.py </p><ol><li><p>Add imports statement</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ElasticAPM </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Get trace config</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Initialize elastic apm and instrument it to flask app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;ELASTIC_APM&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SERVICE_NAME&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">apm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ElasticAPM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variables in Kubernetes deployment file. </p><p><a href="https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/</a> </p><p>If deploying with helm provide above variables in values.yaml and use them in deployment file of charts. </p><p><a href="https://phoenixnap.com/kb/helm-environment-variables" target="_blank" rel="noopener noreferrer">https://phoenixnap.com/kb/helm-environment-variables</a></p></li><li><p>Once your server is up and running you can check trace in Snappyflow Server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="celery-1"></a>Celery<a class="hash-link" href="#celery-1" title="Direct link to heading">#</a></h3><ol><li><p>Install following requirements (Following example is based on redis broker)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install redis </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following code at start of the file where celery app is initialized to setup elastic apm client</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">celery </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> register_exception_tracking</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> register_instrumentation </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROJECT_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow project name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_APP_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow app name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROFILE_KEY&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace Snappyflow Profile key </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   apm_client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;Service_Name&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify service name for tracing</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      server_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      global_labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      verify_server_cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_exception_tracking</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_instrumentation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once instrumentation is done and celery worker is running we can see trace for each celery task in Snappyflow server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on left side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>Refer complete code: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py</a> </p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="docker-1"></a>Docker<a class="hash-link" href="#docker-1" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="django-2"></a>Django<a class="hash-link" href="#django-2" title="Direct link to heading">#</a></h3><ol><li><p>Add</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entries in settings.py </p><ol><li><p>Add import statement </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in INSTALLED_APPS</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django&#x27;</span><span class="token plain">  </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in MIDDLEWARE</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django.middleware.TracingMiddleware&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add this entry for instrumenting Django app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ELASTIC_APM</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;Service name&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DJANGO_TRANSACTION_NAME_FROM_ROUTE&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CENTRAL_CONFIG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variables in docker-compose.yml or docker stack deployment file or at command line when using docker run command for deployment.  </p><p>Eg: </p><p>Docker-compose and stack: <a href="https://docs.docker.com/compose/environment-variables/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/compose/environment-variables/</a> </p><p>Docker RUN: </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d -t -i -e SF_PROJECT_NAME=&#x27;&#x27; \  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">-e SF_APP_NAME=&#x27;&#x27; \ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">-e SF_PROFILE_KEY=&#x27;&#x27; \ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">-p 80:80 \ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">--link redis:redis \   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">--name &lt;container_name&gt; &lt;dockerhub_id/image_name&gt; </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once your server is up and running you can check trace in Snappyflow Server. For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>For complete code refer sample app refer at: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django</a> </p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="flask-2"></a>Flask<a class="hash-link" href="#flask-2" title="Direct link to heading">#</a></h3><ol><li><p>Add </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flask</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-elastic-apm[flask]==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entries in app.py</p><ol><li><p>Add imports statement</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">from elasticapm.contrib.flask import ElasticAPM </span></span><span class="token-line" style="color:#393A34"><span class="token plain">from sf_apm_lib.snappyflow import Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Get trace config</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Initialize elastic apm and instrument it to flask app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;ELASTIC_APM&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SERVICE_NAME&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">apm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ElasticAPM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variables in docker-compose.yml or docker stack deployment file or at command line when using docker run command for deployment.  </p><p>Eg: </p><p>Docker-compose and stack: <a href="https://docs.docker.com/compose/environment-variables/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/compose/environment-variables/</a> </p><p>Docker run cli command: </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d -t -i -e SF_PROJECT_NAME=&#x27;&lt;SF_PROJECT_NAME&gt;&#x27; \  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">-e SF_APP_NAME=&#x27;&lt;SF_APP_NAME&gt;&#x27; \ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">-e SF_PROFILE_KEY=&#x27;&lt;snappyflow profile key&gt;&#x27; \ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">--name &lt;container_name&gt;  &lt;dockerhub_id/image_name&gt; </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once your server is up and running you can check trace in Snappyflow Server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="celery-2"></a>Celery<a class="hash-link" href="#celery-2" title="Direct link to heading">#</a></h3><ol><li><p>Install following requirements (Following example is based on redis broker)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install redis </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following code at start of the file where celery app is initialized to setup elastic apm client</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">celery </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> register_exception_tracking</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> register_instrumentation</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROJECT_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow project name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_APP_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow app name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROFILE_KEY&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace Snappyflow Profile key </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   apm_client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;Service_Name&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify service name for tracing</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      server_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      global_labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      verify_server_cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_exception_tracking</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_instrumentation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once instrumentation is done and celery worker is running we can see trace for each celery task in Snappyflow server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on left side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>Refer complete code: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py</a> </p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="ecs-1"></a>ECS<a class="hash-link" href="#ecs-1" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="django-3"></a>Django<a class="hash-link" href="#django-3" title="Direct link to heading">#</a></h3><ol><li><p>Add  </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entries in settings.py</p><ol><li><p>Add import statement</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in INSTALLED_APPS</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django&#x27;</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entry in MIDDLEWARE:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;elasticapm.contrib.django.middleware.TracingMiddleware&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add this entry for instrumenting Django app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ELASTIC_APM</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;Service name&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DJANGO_TRANSACTION_NAME_FROM_ROUTE&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;CENTRAL_CONFIG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variables in add container section of task definitions. </p><p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html</a></p></li><li><p>Once your server is up and running you can check trace in Snappyflow Server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>For complete code refer sample app refer at: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-django</a> </p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="flask-3"></a>Flask<a class="hash-link" href="#flask-3" title="Direct link to heading">#</a></h3><ol><li><p>Add </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flask</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>entries in requirements.txt file and install these in your project environment </p><p>or </p><p>Install through CLI using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-elastic-apm[flask]==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following entries in app.py </p><ol><li><p>Add imports statement</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ElasticAPM </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Get trace config</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Initialize elastic apm and instrument it to flask app</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;ELASTIC_APM&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SERVICE_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SERVICE_NAME&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify your service name for tracing </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SPAN_FRAMES_MIN_DURATION&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_STACK_TRACE_LIMIT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_CAPTURE_SPAN_STACK_TRACES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&#x27;DEBUG&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">apm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ElasticAPM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Provide SF_PROJECT_NAME, SF_APP_NAME, SF_PROFILE_KEY as an environment variables in add container section of task definitions. </p><p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html</a> </p></li><li><p>Once your server is up and running you can check trace in Snappyflow Server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on lef side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="celery-3"></a>Celery<a class="hash-link" href="#celery-3" title="Direct link to heading">#</a></h3><ol><li><p>Install following requirements (Following example is based on redis broker)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-elastic-apm==6.3.4 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install redis </span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install sf-apm-lib==0.1.1 </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add following code at start of the file where celery app is initialized to setup elastic apm client</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">celery </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> register_exception_tracking</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> register_instrumentation</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Add below part to manually configure the initialization </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROJECT_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow project name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_APP_NAME&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with appropriate Snappyflow app name </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;SF_PROFILE_KEY&gt;&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Replace Snappyflow Profile key </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># End of manual configuration</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   SFTRACE_CONFIG </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   apm_client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">         service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;Service_Name&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Specify service name for tracing</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">         server_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">         global_labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">         verify_server_cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SFTRACE_CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_exception_tracking</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   register_instrumentation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apm_client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Error while fetching snappyflow tracing configurations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Once instrumentation is done and celery worker is running we can see trace for each celery task in Snappyflow server. </p><p>For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 </p><p>Once project and app name is created, Go to View dashboard -&gt; Click on Tracing on left side bar -&gt; Click on view transaction -&gt; Go to real time tab </p></li><li><p>Refer complete code: </p><p><a href="https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py" target="_blank" rel="noopener noreferrer">https://github.com/snappyflow/tracing-reference-apps/blob/master/ref-celery/tasks.py</a> </p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="aws-lambda-1"></a>AWS Lambda<a class="hash-link" href="#aws-lambda-1" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="script-1"></a>Script<a class="hash-link" href="#script-1" title="Direct link to heading">#</a></h3><ol><li><p>Add these python libraries in requirements.txt file. Follow the AWS lambda doc on adding runtime dependency to lambda function. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">0.1</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">elastic</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apm</span><span class="token operator" style="color:#393A34">==</span><span class="token number" style="color:#36acaa">6.3</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Ref: <a href="https://docs.aws.amazon.com/lambda/latest/dg/python-package-create.html#python-package-create-with-dependency" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/lambda/latest/dg/python-package-create.html#python-package-create-with-dependency</a> </p></li><li><p>Instrument lambda function to enable tracing.  </p><ol><li><p>Import Libraries</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> elasticapm </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sf_apm_lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snappyflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Snappyflow </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add code to get SnappyFlow Trace config, outside lambda handler method. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Snappyflow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_PROJECT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SF_PROJECT_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">SF_APP_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SF_APP_NAME&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">profile_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SF_PROFILE_KEY&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">sf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">profile_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SF_APP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">trace_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> snappyflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trace_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Add custom instrumentation in lambda handler function</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lambda_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;SERVICE_NAME_CHANGEME&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      server_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_SERVER_URL&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      verify_cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_VERIFY_SERVER_CERT&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      global_labels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SFTRACE_GLOBAL_LABELS&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   elasticapm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">begin_transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transaction_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;script&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># DO SOME WORK. No return statements. </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">end_transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;success&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># RETURN STATEMENT e.g. return response </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p>Deploy the Lambda function. Follow README to test sample app </p><p>Sample code for reference: </p><p><a href="https://github.com/upendrasahu/aws-lambda-python-tracing-sample" target="_blank" rel="noopener noreferrer">https://github.com/upendrasahu/aws-lambda-python-tracing-sample</a> </p></li><li><p>Configure Lambda function before trigger/invoke. </p><ol><li>Add the environment variableâ€¯SF_PROFILE_KEYâ€¯and set the value to yourâ€¯profile key copied from SnappyFlow. </li><li>Add environment variables SF_APP_NAME and SF_PROJECT_NAME with appropriate values.
<img src="/assets/images/python_aws_picture1-a93940fbdad6f4d4720a7f0237592ae3.png"></li></ol></li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ram-dot-kumar/SFwebsite.git/docs/Tracing/python.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Tracing/java"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Tracing Java Applications</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Tracing/ruby"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Tracing Ruby Applications Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#instances-1" class="table-of-contents__link">Instances</a><ul><li><a href="#django" class="table-of-contents__link">Django</a></li><li><a href="#flask" class="table-of-contents__link">Flask</a></li><li><a href="#script" class="table-of-contents__link">Script</a></li><li><a href="#celery" class="table-of-contents__link">Celery</a></li></ul></li><li><a href="#kubernetes-1" class="table-of-contents__link">Kubernetes</a><ul><li><a href="#django-1" class="table-of-contents__link">Django</a></li><li><a href="#flask-1" class="table-of-contents__link">Flask</a></li><li><a href="#celery-1" class="table-of-contents__link">Celery</a></li></ul></li><li><a href="#docker-1" class="table-of-contents__link">Docker</a><ul><li><a href="#django-2" class="table-of-contents__link">Django</a></li><li><a href="#flask-2" class="table-of-contents__link">Flask</a></li><li><a href="#celery-2" class="table-of-contents__link">Celery</a></li></ul></li><li><a href="#ecs-1" class="table-of-contents__link">ECS</a><ul><li><a href="#django-3" class="table-of-contents__link">Django</a></li><li><a href="#flask-3" class="table-of-contents__link">Flask</a></li><li><a href="#celery-3" class="table-of-contents__link">Celery</a></li></ul></li><li><a href="#aws-lambda-1" class="table-of-contents__link">AWS Lambda</a><ul><li><a href="#script-1" class="table-of-contents__link">Script</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0c660305.js"></script>
<script src="/assets/js/main.121dd3aa.js"></script>
</body>
</html>